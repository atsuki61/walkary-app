{% extends 'walkary/base.html' %}
{% load static %}

{% block title %}walkary{% endblock %}
{% block body_class %}no-scroll{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'walkary/css/graph.css' %}" />
{% endblock %}

{% block nav_graph_class %}active{% endblock %}

{% block content %}
  <div
    class="chart-container"
    style="
      width: 90%;
      height: 500px;
      margin: 20px auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(149, 157, 165, 0.15);
    "
  >
    <canvas
      id="stepsChart"
      role="img"
      aria-label="直近7日間の歩行距離の折れ線グラフ（単位: メートル）"
      aria-describedby="stepsTableCaption"
    ></canvas>
  </div>
  <div class="chart-table-wrapper">
    <table id="stepsTable" class="sr-only">
      <caption id="stepsTableCaption">
        直近7日間の歩行距離データ（スクリーンリーダー向け）
      </caption>
      <thead>
        <tr>
          <th scope="col">日付</th>
          <th scope="col">距離 (m)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function () {
        const walkedData =
          JSON.parse(localStorage.getItem("walked_data")) || [];

        // データを日付でソート
        walkedData.sort((a, b) => new Date(a.date) - new Date(b.date));

        // 日付範囲を生成
        const dateRange = [];
        const startDate = new Date(
          walkedData[0]?.date || new Date().toISOString().split("T")[0]
        );
        const endDate = new Date(
          walkedData[walkedData.length - 1]?.date ||
            new Date().toISOString().split("T")[0]
        );

        for (
          let d = new Date(startDate);
          d <= endDate;
          d.setDate(d.getDate() + 1)
        ) {
          dateRange.push(new Date(d).toISOString().split("T")[0]);
        }

        // 日付範囲を元にデータを補完
        const completeData = dateRange.map((date) => {
          const existingEntry = walkedData.find((item) => item.date === date);
          return existingEntry ? existingEntry : { date: date, steps: 0 };
        });

        // デフォルトで直近7日間のデータを抽出
        const recentData = completeData.slice(-7);

        // 年を除いた日付を作成
        const labels = recentData.map((item) => {
          const date = new Date(item.date);
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${month}/${day}`;
        });

        const steps = recentData.map((item) => item.steps);

        // グラフを描画
        const ctx = document.getElementById("stepsChart").getContext("2d");

        // グラデーションの作成
        const gradientFill = ctx.createLinearGradient(0, 0, 0, 400);
        gradientFill.addColorStop(0, "rgba(26, 115, 232, 0.1)");
        gradientFill.addColorStop(1, "rgba(26, 115, 232, 0.0)");

        const gradientLine = ctx.createLinearGradient(0, 0, 400, 0);
        gradientLine.addColorStop(0, "#1a73e8");
        gradientLine.addColorStop(1, "#6c5ce7");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "歩いた距離",
                data: steps,
                borderColor: gradientLine,
                backgroundColor: gradientFill,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: "#ffffff",
                pointBorderColor: "#1a73e8",
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: "#ffffff",
                pointHoverBorderColor: "#6c5ce7",
                pointHoverBorderWidth: 3,
                pointShadowOffsetX: 1,
                pointShadowOffsetY: 1,
                pointShadowBlur: 5,
                pointShadowColor: "rgba(0, 0, 0, 0.1)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
              padding: {
                top: 20,
                right: 20,
                bottom: 20,
                left: 20,
              },
            },
            plugins: {
              legend: {
                display: true,
                labels: {
                  font: {
                    family:
                      "'Inter', -apple-system, BlinkMacSystemFont, sans-serif",
                    size: 14,
                    weight: "600",
                  },
                  padding: 20,
                  usePointStyle: true,
                  pointStyle: "circle",
                  color: "#2c3e50",
                },
              },
              tooltip: {
                backgroundColor: "rgba(255, 255, 255, 0.98)",
                titleColor: "#2c3e50",
                bodyColor: "#2c3e50",
                titleFont: {
                  family:
                    "'Inter', -apple-system, BlinkMacSystemFont, sans-serif",
                  size: 14,
                  weight: "600",
                },
                bodyFont: {
                  family:
                    "'Inter', -apple-system, BlinkMacSystemFont, sans-serif",
                  size: 14,
                },
                padding: 12,
                borderColor: "rgba(26, 115, 232, 0.1)",
                borderWidth: 1,
                displayColors: false,
                callbacks: {
                  label: function (context) {
                    return `${context.parsed.y.toLocaleString()} m`;
                  },
                },
                cornerRadius: 8,
                caretSize: 6,
                boxShadow: "0 4px 6px rgba(0, 0, 0, 0.1)",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                  drawBorder: false,
                  lineWidth: 1,
                },
                border: {
                  display: false,
                },
                ticks: {
                  font: {
                    family:
                      "'Inter', -apple-system, BlinkMacSystemFont, sans-serif",
                    size: 12,
                    weight: "500",
                  },
                  padding: 10,
                  color: "#2c3e50",
                  callback: function (value) {
                    return value.toLocaleString() + " m";
                  },
                },
                title: {
                  display: true,
                  text: "歩いた距離",
                  font: {
                    family:
                      "'Inter', -apple-system, BlinkMacSystemFont, sans-serif",
                    size: 14,
                    weight: "600",
                  },
                  padding: { top: 10, bottom: 10 },
                  color: "#2c3e50",
                },
              },
              x: {
                grid: {
                  display: false,
                },
                border: {
                  display: false,
                },
                ticks: {
                  font: {
                    family:
                      "'Inter', -apple-system, BlinkMacSystemFont, sans-serif",
                    size: 12,
                    weight: "500",
                  },
                  padding: 10,
                  color: "#2c3e50",
                },
              },
            },
            interaction: {
              intersect: false,
              mode: "index",
            },
            animation: {
              duration: 1000,
              easing: "easeInOutQuart",
            },
            elements: {
              line: {
                tension: 0.4,
                borderWidth: 3,
                borderJoinStyle: "round",
                capBezierPoints: true,
              },
            },
          },
        });

        // 代替表（スクリーンリーダー向け）を生成
        const tbody = document.querySelector("#stepsTable tbody");
        if (tbody) {
          tbody.innerHTML = "";
          recentData.forEach((item) => {
            const tr = document.createElement("tr");
            const tdDate = document.createElement("td");
            const tdSteps = document.createElement("td");
            tdDate.textContent = item.date;
            tdSteps.textContent = (item.steps ?? 0).toLocaleString();
            tr.appendChild(tdDate);
            tr.appendChild(tdSteps);
            tbody.appendChild(tr);
          });
        }
      });
  </script>
{% endblock %}
